# Implementation Plan: Message Length Limit Adjustment

**Branch**: `021-message-length-limit` | **Date**: 2026-02-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/021-message-length-limit/spec.md`

## Summary

Remove the PostgreSQL CHECK constraint on `messages.content` (currently `char_length(content) <= 2000`) and align all hardcoded 2000-char limits across the stack: increase `_truncate_for_storage()` safety-net limit, update web UI counter to 4096 chars (Telegram parity), update Pydantic input validation, and update affected tests. No changes to LLM `max_tokens` or Telegram platform limits.

## Technical Context

**Language/Version**: Python 3.12+
**Primary Dependencies**: FastAPI, SQLAlchemy 2.0, Alembic, python-telegram-bot 21.x, Pydantic v2, Jinja2/HTMX
**Storage**: PostgreSQL 16 + pgvector (existing DB with Alembic migrations, current head: `014`)
**Testing**: pytest 8.x, pytest-asyncio
**Target Platform**: Linux server (VPS, systemd + Nginx)
**Project Type**: Web application (backend + SSR frontend)
**Performance Goals**: N/A — schema-only change, no performance impact
**Constraints**: Migration must be backward-compatible; no data migration needed
**Scale/Scope**: ~50 wines, small user base; 10 files affected across 4 layers (DB, API, UI, tests)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **Clean Architecture** (layers: Routers → Services → Repos → Models) | PASS | Changes span all layers but respect boundaries: migration (DB), service (truncation), schema (API), template (UI) |
| **Database First** (schema defines API; Alembic for all changes) | PASS | New Alembic migration (015) drops CHECK constraint first, then code changes follow |
| **TDD** (Red → Green → Refactor) | PASS | Update existing tests to reflect new limits before changing implementation |
| **RAG-First** (recommendations from catalog) | N/A | No changes to recommendation logic |
| **18+ / no sales** | N/A | No product changes |
| **Education > conversion** | N/A | No product changes |
| **Privacy** | N/A | No data access changes |
| **Ruff linting** | PASS | All changed files will be linted |
| **Commitizen** | PASS | Conventional commits |

**Gate result**: PASS — no violations.

## Project Structure

### Documentation (this feature)

```text
specs/021-message-length-limit/
├── plan.md              # This file
├── research.md          # Technical decisions and rationale
├── data-model.md        # Entity changes (CHECK constraint removal)
├── quickstart.md        # Test scenarios for validation
├── checklists/          # Quality checklists
│   └── requirements.md
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (files affected)

```text
backend/
├── migrations/
│   └── versions/
│       └── 015_drop_message_content_length_constraint.py  # NEW: Alembic migration
├── app/
│   ├── config.py                    # NO CHANGE (llm_max_tokens stays 2000)
│   ├── models/
│   │   └── message.py               # NO CHANGE (no Python-level constraint)
│   ├── schemas/
│   │   └── chat.py                  # UPDATE: max_length 2000 → 4096
│   ├── services/
│   │   └── telegram_bot.py          # UPDATE: _truncate_for_storage default, comment
│   └── templates/
│       └── chat.html                # UPDATE: maxlength, JS counter, warning threshold
├── tests/
│   ├── unit/
│   │   └── test_chat_models.py      # UPDATE: validation boundary tests
│   └── contract/
│       └── test_chat_messages.py    # UPDATE: max-length contract tests
└── bot/
    └── sender.py                    # NO CHANGE (1024 caption is Telegram limit)
```

**Structure Decision**: Existing web application structure. No new directories or modules. All changes are modifications to existing files plus one new migration file.

## Complexity Tracking

> No constitution violations to justify. This feature is a straightforward constraint adjustment across the existing stack.
