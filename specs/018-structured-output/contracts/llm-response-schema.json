{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "sommelier-response",
  "title": "Sommelier Response Schema",
  "description": "JSON Schema for structured LLM output used with OpenRouter response_format parameter. All objects must have additionalProperties: false per Claude structured output requirements.",

  "response_format_wrapper": {
    "_comment": "This is how the schema is passed to the OpenAI SDK chat.completions.create() call",
    "type": "json_schema",
    "json_schema": {
      "name": "sommelier_response",
      "strict": true,
      "schema": {
        "type": "object",
        "properties": {
          "response_type": {
            "type": "string",
            "enum": ["recommendation", "informational", "off_topic"],
            "description": "Тип ответа: recommendation (с винами), informational (общий вопрос), off_topic (нерелевантный запрос)"
          },
          "intro": {
            "type": "string",
            "description": "Вступительный текст (1-2 предложения). Для recommendation — связь с запросом. Для informational — начало ответа. Для off_topic — вежливое перенаправление."
          },
          "wines": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "wine_name": {
                  "type": "string",
                  "description": "Точное название вина из каталога (как вернул инструмент поиска)"
                },
                "description": {
                  "type": "string",
                  "description": "Описание вина: характеристики + почему подходит к запросу (2-3 предложения, markdown)"
                }
              },
              "required": ["wine_name", "description"],
              "additionalProperties": false
            },
            "description": "Список рекомендованных вин (0-3). Пустой массив для informational и off_topic ответов."
          },
          "closing": {
            "type": "string",
            "description": "Завершающий текст: вопрос для продолжения диалога или приглашение задать вопрос."
          },
          "guard_type": {
            "type": ["string", "null"],
            "enum": ["off_topic", "prompt_injection", "social_engineering", null],
            "description": "Тип защиты. null для обычных запросов. Заполняется при off_topic, prompt_injection или social_engineering."
          }
        },
        "required": ["response_type", "intro", "wines", "closing", "guard_type"],
        "additionalProperties": false
      }
    }
  },

  "examples": {
    "recommendation": {
      "response_type": "recommendation",
      "intro": "Отличный выбор! К стейку прекрасно подойдут насыщенные красные вина с хорошей танинностью.",
      "wines": [
        {
          "wine_name": "Chateau Margaux 2018",
          "description": "**Chateau Margaux, Бордо, Франция, 2018, 4500 руб.**\nКлассическое бордо с мощными танинами и нотами чёрной смородины. Идеально дополнит жирность стейка и раскроет вкус мяса на гриле."
        },
        {
          "wine_name": "Barolo DOCG 2019",
          "description": "**Barolo DOCG, Пьемонт, Италия, 2019, 3200 руб.**\nИтальянская классика из неббиоло — высокие танины и кислотность прекрасно балансируют жирность стейка. Ноты вишни, трюфеля и розы."
        },
        {
          "wine_name": "Malbec Reserva 2020",
          "description": "**Malbec Reserva, Мендоса, Аргентина, 2020, 1800 руб.**\nНасыщенный мальбек с бархатистыми танинами и ягодным характером. Доступная альтернатива европейской классике, которая отлично работает с красным мясом."
        }
      ],
      "closing": "Какой ценовой диапазон вам ближе? Могу подобрать ещё варианты!",
      "guard_type": null
    },
    "informational": {
      "response_type": "informational",
      "intro": "Танины — это природные полифенолы, которые содержатся в кожице, косточках и гребнях винограда.",
      "wines": [],
      "closing": "Хотите, подберу вино с выраженными или мягкими танинами?",
      "guard_type": null
    },
    "off_topic": {
      "response_type": "off_topic",
      "intro": "Это интересный вопрос, но я специализируюсь на вине! Давайте лучше подберу что-нибудь вкусное.",
      "wines": [
        {
          "wine_name": "Prosecco DOC Brut",
          "description": "**Prosecco DOC Brut, Венето, Италия, NV, 1200 руб.**\nЛёгкое игристое для хорошего настроения — свежие яблочные ноты и мелкие пузырьки."
        }
      ],
      "closing": "Что предпочитаете — красное, белое, или может игристое?",
      "guard_type": "off_topic"
    }
  }
}
