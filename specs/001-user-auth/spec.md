# Спецификация: Регистрация и авторизация

**Ветка**: `001-user-auth`
**Создана**: 2026-02-02
**Статус**: Черновик
**Вход**: Регистрация и авторизация пользователей для AI-Sommelier. Email + пароль, сессии 7 дней, проверка возраста 18+, rate limiting 5 попыток / 15 мин. Соответствие 152-ФЗ.

## Пользовательские сценарии

### User Story 1 — Регистрация нового пользователя (Приоритет: P1)

Новый пользователь хочет создать аккаунт, чтобы получать персонализированные рекомендации по вину и сохранять историю диалогов.

**Почему P1**: Без регистрации невозможна персонализация — ключевая ценность продукта. Это входная точка для всех пользователей.

**Независимый тест**: Можно полностью протестировать, создав аккаунт и войдя в систему. Пользователь получает доступ к чату с AI-сомелье.

**Сценарии приёмки**:

1. **Given** пользователь на странице регистрации, **When** вводит валидный email, пароль и подтверждает возраст 18+, **Then** аккаунт создаётся и пользователь автоматически входит в систему
2. **Given** пользователь вводит email, который уже зарегистрирован, **When** отправляет форму, **Then** видит сообщение «Email уже используется» без раскрытия информации о существовании аккаунта третьим лицам
3. **Given** пользователь не подтвердил возраст 18+, **When** пытается зарегистрироваться, **Then** регистрация блокируется с сообщением о возрастном ограничении

---

### User Story 2 — Вход в систему (Приоритет: P1)

Зарегистрированный пользователь хочет войти в свой аккаунт, чтобы продолжить использование сервиса с сохранённым профилем.

**Почему P1**: Вход — обязательный компаньон регистрации. Без него регистрация бесполезна.

**Независимый тест**: Можно протестировать, войдя с существующими учётными данными и получив доступ к защищённым страницам.

**Сценарии приёмки**:

1. **Given** пользователь на странице входа, **When** вводит корректный email и пароль, **Then** входит в систему и видит главную страницу с чатом
2. **Given** пользователь вводит неверный пароль, **When** отправляет форму, **Then** видит сообщение «Неверный email или пароль» (без указания, что именно неверно)
3. **Given** пользователь совершил 5 неудачных попыток входа за 15 минут, **When** пытается войти снова, **Then** видит сообщение о временной блокировке с указанием времени ожидания
4. **Given** пользователь успешно вошёл, **When** закрывает браузер и возвращается в течение 7 дней, **Then** остаётся авторизованным (сессия активна)

---

### User Story 3 — Выход из системы (Приоритет: P2)

Пользователь хочет выйти из аккаунта, чтобы защитить свои данные на общем устройстве.

**Почему P2**: Важно для безопасности, но не блокирует основной функционал.

**Независимый тест**: Можно протестировать, нажав «Выйти» и убедившись, что доступ к защищённым страницам закрыт.

**Сценарии приёмки**:

1. **Given** пользователь авторизован, **When** нажимает «Выйти», **Then** сессия завершается и пользователь перенаправляется на страницу входа
2. **Given** пользователь вышел из системы, **When** пытается открыть защищённую страницу по прямой ссылке, **Then** перенаправляется на страницу входа

---

### User Story 4 — Восстановление пароля (Приоритет: P3)

Пользователь забыл пароль и хочет восстановить доступ к аккаунту.

**Почему P3**: Нужно для полноценного продукта, но для MVP можно отложить — пользователи могут создать новый аккаунт.

**Независимый тест**: Можно протестировать, запросив сброс пароля и установив новый через полученную ссылку.

**Сценарии приёмки**:

1. **Given** пользователь на странице восстановления пароля, **When** вводит зарегистрированный email, **Then** получает письмо со ссылкой для сброса пароля
2. **Given** пользователь перешёл по ссылке сброса, **When** вводит новый пароль, **Then** пароль обновляется и пользователь может войти с новым паролем
3. **Given** ссылка для сброса пароля старше 1 часа, **When** пользователь пытается её использовать, **Then** видит сообщение об истечении срока действия

---

### Граничные случаи

- Что происходит при вводе email с опечаткой в домене (например, gmial.com)? → Система принимает любой синтаксически валидный email, проверка домена не производится
- Что происходит при одновременном входе с нескольких устройств? → Разрешено, каждое устройство получает свою сессию
- Что происходит при смене пароля во время активной сессии на другом устройстве? → Существующие сессии остаются активными до истечения срока (7 дней)
- Что происходит при попытке регистрации с временным email (mailinator и т.п.)? → Принимается, фильтрация временных email не производится

## Требования

### Функциональные требования

- **FR-001**: Система ДОЛЖНА позволять создавать аккаунт с email и паролем
- **FR-002**: Система ДОЛЖНА требовать подтверждение возраста 18+ при регистрации (чекбокс)
- **FR-003**: Система ДОЛЖНА валидировать формат email (синтаксическая проверка)
- **FR-004**: Система ДОЛЖНА требовать пароль минимум 8 символов
- **FR-005**: Система ДОЛЖНА хранить пароли в захешированном виде
- **FR-006**: Система ДОЛЖНА поддерживать сессии длительностью 7 дней
- **FR-007**: Система ДОЛЖНА блокировать вход после 5 неудачных попыток на 15 минут
- **FR-008**: Система ДОЛЖНА позволять пользователю выйти из системы
- **FR-009**: Система ДОЛЖНА отправлять email для сброса пароля
- **FR-010**: Ссылка сброса пароля ДОЛЖНА быть действительна 1 час
- **FR-011**: Система НЕ ДОЛЖНА раскрывать, существует ли email в системе (защита от перебора)
- **FR-012**: Система ДОЛЖНА хранить данные пользователей на территории РФ (152-ФЗ)

### Ключевые сущности

- **Пользователь (User)**: email, хеш пароля, подтверждение возраста, дата регистрации, статус (активен/заблокирован)
- **Сессия (Session)**: токен, ID пользователя, дата создания, дата истечения
- **Попытка входа (LoginAttempt)**: email, IP-адрес, время, результат (успех/неудача)
- **Токен сброса пароля (PasswordResetToken)**: токен, ID пользователя, дата создания, использован (да/нет)

## Критерии успеха

### Измеримые результаты

- **SC-001**: Пользователь завершает регистрацию менее чем за 2 минуты
- **SC-002**: Пользователь входит в систему менее чем за 30 секунд
- **SC-003**: 95% пользователей успешно завершают регистрацию с первой попытки
- **SC-004**: Система корректно блокирует 100% попыток входа после превышения лимита
- **SC-005**: Письмо для сброса пароля доставляется в течение 5 минут

## Допущения

- Email-сервис для отправки писем будет доступен (внешний провайдер)
- Пользователи имеют доступ к своей электронной почте
- Один email = один аккаунт (без мульти-аккаунтов на один email)
- Подтверждение email не требуется для MVP (достаточно чекбокса возраста)

## Вне скоупа

- OAuth/социальный вход (Google, VK, Яндекс)
- Двухфакторная аутентификация (2FA)
- Подтверждение email через ссылку
- Управление несколькими сессиями (просмотр/завершение)
- Аудит-лог действий пользователя
