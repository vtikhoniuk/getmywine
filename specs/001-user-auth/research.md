# Исследование: Регистрация и авторизация

**Дата**: 2026-02-02
**Фича**: 001-user-auth

## Решения

### 1. Хеширование паролей

**Решение**: bcrypt через Passlib

**Обоснование**:
- Индустриальный стандарт для хеширования паролей
- Встроенная защита от timing attacks
- Автоматическая генерация соли
- Настраиваемый work factor (cost)

**Альтернативы**:
- Argon2: Более современный, но bcrypt достаточен для MVP и проще в настройке
- scrypt: Хорош для защиты от GPU-атак, но избыточен для нашего масштаба

**Конфигурация**:
```python
from passlib.context import CryptContext
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

---

### 2. Управление сессиями

**Решение**: JWT токены в HttpOnly cookies

**Обоснование**:
- Stateless — не требует хранения сессий в БД
- HttpOnly cookies защищают от XSS
- Срок жизни 7 дней соответствует требованиям
- Простота реализации с python-jose

**Альтернативы**:
- Server-side sessions (Redis): Более контролируемые, но добавляет зависимость
- Opaque tokens в БД: Проще отзывать, но требует запрос к БД на каждый запрос

**Структура токена**:
```json
{
  "sub": "user_id",
  "exp": "timestamp",
  "iat": "timestamp"
}
```

**Конфигурация**:
- Алгоритм: HS256
- Срок жизни: 7 дней (604800 секунд)
- Secret: из переменной окружения JWT_SECRET

---

### 3. Rate Limiting

**Решение**: In-memory rate limiter с slowapi

**Обоснование**:
- Простая интеграция с FastAPI
- Достаточно для MVP (30 одновременных сессий)
- Не требует Redis или внешних зависимостей

**Альтернативы**:
- Redis-based (fastapi-limiter): Масштабируемо, но избыточно для MVP
- Nginx rate limiting: Хорош для production, но сложнее настроить per-endpoint

**Конфигурация**:
- Лимит входа: 5 попыток / 15 минут на IP + email
- Лимит регистрации: 3 попытки / час на IP
- Лимит сброса пароля: 3 попытки / час на email

---

### 4. Email-сервис

**Решение**: SMTP через внешний провайдер (конфигурируемый)

**Обоснование**:
- Абстракция через интерфейс позволяет сменить провайдера
- Для MVP достаточно любого SMTP (Yandex, Mail.ru, Sendgrid)
- Асинхронная отправка через background task

**Альтернативы**:
- Transactional email API (Sendgrid, Mailgun): Лучше для production, но платные
- Локальный SMTP: Письма часто попадают в спам

**Интерфейс**:
```python
class EmailService:
    async def send_password_reset(self, email: str, token: str) -> bool
```

---

### 5. Валидация email

**Решение**: Синтаксическая проверка через Pydantic EmailStr

**Обоснование**:
- Достаточно для MVP (спецификация явно указывает: без проверки домена)
- Встроено в Pydantic, не требует дополнительных зависимостей

**Альтернативы**:
- email-validator с проверкой MX: Более надёжно, но замедляет регистрацию
- Подтверждение email: Вне скоупа MVP

---

### 6. Защита от перебора email

**Решение**: Единообразные ответы + timing attack protection

**Обоснование**:
- FR-011 требует не раскрывать существование email
- Одинаковое время ответа независимо от результата
- Одинаковое сообщение "Неверный email или пароль"

**Реализация**:
```python
# Всегда выполняем хеширование, даже если пользователь не найден
pwd_context.verify(password, fake_hash)
```

---

## Зависимости

```
# requirements.txt (auth-related)
fastapi>=0.109.0
sqlalchemy>=2.0.0
alembic>=1.13.0
asyncpg>=0.29.0
passlib[bcrypt]>=1.7.4
python-jose[cryptography]>=3.3.0
slowapi>=0.1.9
pydantic[email]>=2.5.0
aiosmtplib>=3.0.0
```

## Открытые вопросы

Нет — все технические решения приняты.
