# Feature Specification: Telegram-бот для GetMyWine

**Feature Branch**: `011-telegram-bot`
**Created**: 2026-02-05
**Status**: Draft
**Input**: User description: "Реализуй EPIC-011 из /home/vt/aiwine-hub/50-project-docs/getmywine/02-user-story-map.md"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Первый контакт с ботом и регистрация (Priority: P1)

Пользователь находит бота в Telegram, видит в его описании, что нажатие /start означает подтверждение возраста 18+, запускает бота и получает приветственное сообщение с персонализированными рекомендациями вин. Создается профиль пользователя, привязанный к Telegram ID.

**Why this priority**: Это точка входа для всех пользователей Telegram. Без этой функциональности бот не может работать. Обеспечивает соблюдение возрастных ограничений и создает базу для персонализации.

**Independent Test**: Можно полностью протестировать, открыв бота в Telegram, прочитав описание с возрастным ограничением, отправив /start и получив приветственное сообщение с 3 рекомендациями вин. Доставляет ценность: пользователь сразу видит возможности бота и получает первые рекомендации.

**Acceptance Scenarios**:

1. **Given** пользователь открывает карточку бота в Telegram, **When** он читает описание, **Then** там указано, что при нажатии /start пользователь подтверждает, что ему есть 18 лет
2. **Given** пользователь впервые запускает бота, **When** он нажимает кнопку "Start" или отправляет /start, **Then** бот создает профиль пользователя и отправляет приветственное сообщение с описанием возможностей и 3 персонализированными рекомендациями вин на основе контекста (сезон, праздники, день недели)
3. **Given** пользователь уже имеет аккаунт в веб-версии, **When** он запускает бота, **Then** бот может связать Telegram ID с существующим email-аккаунтом и использовать тот же профиль

---

### User Story 2 - Получение рекомендаций вин (Priority: P1)

Пользователь отправляет свободный текстовый запрос о вине (например, "что взять к стейку", "хочу легкое белое", "посоветуй что-нибудь на романтический ужин"), и бот рекомендует конкретные вина из каталога с обоснованием выбора, учитывая профиль пользователя.

**Why this priority**: Это основная ценность сервиса - предоставление персонализированных рекомендаций. Без этой функции бот теряет смысл существования.

**Independent Test**: Можно протестировать, отправив любой текстовый запрос о вине и получив структурированную рекомендацию с обоснованием. Доставляет ценность: пользователь решает свою задачу выбора вина через привычный мессенджер.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован в боте, **When** он отправляет текстовый запрос о вине в свободной форме, **Then** бот анализирует запрос и рекомендует конкретные вина из каталога с обоснованием
2. **Given** пользователь спрашивает про вино к блюду, **When** он описывает блюдо (например, "стейк средней прожарки"), **Then** бот рекомендует вина, которые сочетаются с этим блюдом, и объясняет, почему это сочетание работает
3. **Given** пользователь спрашивает про вино для события, **When** он описывает событие (например, "день рождения друга"), **Then** бот учитывает социальный контекст и предлагает несколько вариантов с обоснованием
4. **Given** у пользователя заполнен вкусовой профиль, **When** он запрашивает рекомендацию, **Then** бот учитывает предпочтения пользователя (сладость, кислотность, бюджет, прошлый опыт)
5. **Given** пользователь затрудняется сформулировать запрос, **When** бот отправляет приветственное сообщение, **Then** отображаются персонализированные подсказки для запросов (1-3 варианта)

---

### User Story 3 - Просмотр информации о рекомендованном вине (Priority: P2)

Когда бот рекомендует вино, пользователь видит структурированную информацию: название, регион, сорт винограда, год урожая, вкусовые характеристики, описание, ориентировочная цена и обоснование рекомендации - всё в удобном для чтения формате мессенджера.

**Why this priority**: Информация о вине помогает пользователю принять решение о покупке и обучает его понимать вино. Критична для доверия к рекомендациям.

**Independent Test**: Можно протестировать, запросив рекомендацию вина и проверив, что вся информация отображается структурированно и читаемо на мобильном экране. Доставляет ценность: пользователь получает полную информацию для принятия решения.

**Acceptance Scenarios**:

1. **Given** бот рекомендует вино, **When** пользователь получает ответ, **Then** информация отображается структурированно: название, регион, сорт, год, вкусовые характеристики, описание
2. **Given** бот показывает информацию о вине, **When** пользователь читает её на мобильном устройстве, **Then** текст читаем без горизонтальной прокрутки, вкусовые характеристики понятны неспециалисту
3. **Given** бот рекомендует вино, **When** пользователь видит цену, **Then** она показана в понятном виде с указанием валюты
4. **Given** бот рекомендует вино, **When** пользователь читает обоснование, **Then** оно связано с его профилем ("Вам понравится, потому что вы любите...") и выделено отдельно от описания вина

---

### User Story 4 - Управление профилем через бота (Priority: P3)

Пользователь может просмотреть свой вкусовой профиль, обновить предпочтения (сладость, кислотность, бюджет), дать обратную связь на рекомендации ("понравилось" / "не понравилось") через команды бота, не переходя в веб-версию.

**Why this priority**: Позволяет пользователям полноценно работать с сервисом через Telegram без необходимости открывать веб-версию. Улучшает персонализацию через обратную связь.

**Independent Test**: Можно протестировать, отправив команду /profile, обновив предпочтения и дав обратную связь на рекомендацию. Доставляет ценность: пользователь управляет своим опытом без смены приложения.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован, **When** он отправляет команду /profile, **Then** бот показывает текущий вкусовой профиль (предпочтения по сладости, кислотности, танинам, бюджет, опыт с вином)
2. **Given** пользователь видит свой профиль, **When** он хочет обновить предпочтения, **Then** бот предлагает диалог для изменения параметров (аналогично онбордингу в веб-версии)
3. **Given** пользователь получил рекомендацию вина, **When** он попробовал это вино, **Then** он может дать обратную связь ("понравилось" / "не понравилось"), и бот обновляет профиль
4. **Given** пользователь изменил бюджет, **When** он запрашивает новую рекомендацию, **Then** бот учитывает обновленный бюджет

---

### User Story 5 - Помощь и навигация (Priority: P3)

Пользователь может в любой момент запросить список доступных команд через /help и получить понятное объяснение возможностей бота, а также уточнить свой предыдущий запрос обычным текстовым сообщением без необходимости "сбрасывать" диалог.

**Why this priority**: Обеспечивает удобство использования и снижает порог входа для новых пользователей. Позволяет пользователям исследовать функции самостоятельно.

**Independent Test**: Можно протестировать, отправив /help и получив список команд, затем уточнив предыдущий запрос. Доставляет ценность: пользователь понимает, что может делать с ботом.

**Acceptance Scenarios**:

1. **Given** пользователь не знает, что может делать бот, **When** он отправляет команду /help, **Then** бот показывает список доступных команд с кратким описанием каждой
2. **Given** пользователь задал вопрос и получил ответ, **When** он хочет уточнить свой запрос, **Then** он просто отправляет уточняющее сообщение, и бот учитывает контекст предыдущего диалога
3. **Given** пользователь не понимает, как работает рекомендация, **When** он спрашивает об этом в свободной форме, **Then** бот объясняет свою логику простым языком

---

### Edge Cases

- **Что происходит, если пользователь пытается связать Telegram с несуществующим email-аккаунтом?** Бот сообщает, что аккаунт не найден, и предлагает создать новый или проверить введенные данные.

- **Что происходит, если пользователь отправляет запрос, на который нет подходящего вина в каталоге?** Бот честно сообщает, что подходящего вина не нашлось, и предлагает альтернативные варианты или уточнение критериев.

- **Как система обрабатывает сообщения, когда бот недоступен (технические работы, перезапуск)?** Сообщения пользователей сохраняются Telegram, и при восстановлении бот обрабатывает их в порядке очереди с уведомлением о задержке.

- **Что происходит, если пользователь удаляет диалог с ботом в Telegram?** История диалога остается в базе данных и доступна через веб-версию. При новом обращении к боту создается новая сессия, но профиль пользователя сохраняется.

- **Как бот обрабатывает нераспознанные команды или несвязный текст?** Бот вежливо сообщает, что не понял запрос, и предлагает переформулировать или использовать /help.

- **Что происходит, если LLM/сервис рекомендаций временно недоступен?** Бот возвращает сообщение об ошибке ("К сожалению, сервис рекомендаций временно недоступен") и предлагает попробовать позже.

- **Что происходит, если пользователь младше 18 лет использует бота (игнорируя предупреждение в описании)?** Система полагается на честность пользователя и юридическое соглашение в описании бота. Выполнение /start означает согласие с возрастным ограничением.

- **Как система обрабатывает одновременный доступ к профилю из веб-версии и бота?** Профиль синхронизирован в реальном времени: изменения в одном канале немедленно доступны в другом.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Бот ДОЛЖЕН быть доступен для поиска в Telegram по уникальному имени и иметь описание, в котором указано, что при нажатии /start пользователь подтверждает, что ему есть 18 лет

- **FR-002**: Бот ДОЛЖЕН обрабатывать команду /start и при первом запуске создавать профиль пользователя, используя Telegram ID как уникальный идентификатор, без дополнительных шагов подтверждения возраста

- **FR-003**: Бот ДОЛЖЕН отправлять приветственное сообщение после выполнения /start, содержащее краткое описание возможностей и 3 персонализированные рекомендации вин на основе контекста (сезон, праздники, день недели)

- **FR-004**: Бот ДОЛЖЕН работать с тем же профилем пользователя, что и веб-версия, обеспечивая синхронизацию данных между каналами

- **FR-005**: Бот ДОЛЖЕН предоставлять возможность связать Telegram ID с существующим email-аккаунтом для пользователей, которые уже зарегистрированы в веб-версии

- **FR-006**: Бот ДОЛЖЕН принимать свободные текстовые запросы о вине и понимать разные формулировки ("что взять к стейку", "хочу легкое белое", "посоветуй на романтический ужин")

- **FR-007**: Бот ДОЛЖЕН рекомендовать только вина из каталога (не галлюцинировать) и предоставлять обоснование каждой рекомендации

- **FR-008**: Бот ДОЛЖЕН учитывать вкусовой профиль пользователя при формировании рекомендаций (сладость, кислотность, танины, тело, ароматы, бюджет, прошлый опыт)

- **FR-009**: Бот ДОЛЖЕН отображать информацию о рекомендованном вине структурированно: название, регион, сорт винограда, год урожая, вкусовые характеристики, описание, ориентировочная цена

- **FR-010**: Бот ДОЛЖЕН адаптировать контент для мобильного формата: текст читаем без горизонтальной прокрутки, обоснование выделено отдельно

- **FR-011**: Бот ДОЛЖЕН отображать персонализированные подсказки для запросов (1-3 варианта) при отправке приветственного сообщения или когда пользователь затрудняется сформулировать запрос

- **FR-012**: Бот ДОЛЖЕН обрабатывать команду /profile и показывать текущий вкусовой профиль пользователя

- **FR-013**: Бот ДОЛЖЕН предоставлять возможность обновить вкусовые предпочтения (сладость, кислотность, танины, бюджет) через диалог

- **FR-014**: Бот ДОЛЖЕН принимать обратную связь на рекомендации ("понравилось" / "не понравилось") и обновлять профиль пользователя на её основе

- **FR-015**: Бот ДОЛЖЕН обрабатывать команду /help и показывать список доступных команд с кратким описанием

- **FR-016**: Бот ДОЛЖЕН сохранять всю историю диалога в базе данных (аналогично веб-версии) для обеспечения персонализации

- **FR-017**: Бот ДОЛЖЕН учитывать контекст текущей сессии (последние сообщения) при генерации рекомендаций

- **FR-018**: Бот НЕ ДОЛЖЕН предоставлять отдельные команды для просмотра прошлых сессий (пользователь может скроллить назад в мессенджере)

- **FR-019**: Система ДОЛЖНА поддерживать раздельный запуск: Telegram-бот может работать независимо от веб-сервера, веб-сервер независимо от бота, или оба компонента одновременно

- **FR-020**: Конфигурация запуска компонентов (бот / веб / оба) ДОЛЖНА управляться переменными окружения

- **FR-021**: Бот и веб-версия ДОЛЖНЫ использовать единый API Gateway, одну базу данных пользователей и одну логику рекомендаций (LLM + RAG)

- **FR-022**: Система ДОЛЖНА защищать от подмены Telegram ID через верификацию токена, предоставляемого Telegram API

- **FR-023**: Бот ДОЛЖЕН обрабатывать нераспознанные команды и несвязный текст, вежливо сообщая, что не понял запрос, и предлагая помощь

- **FR-024**: Бот ДОЛЖЕН честно сообщать, если подходящего вина не нашлось в каталоге, и предлагать альтернативные варианты или уточнение критериев

- **FR-025**: Бот ДОЛЖЕН определять язык общения: изначально по локали Telegram пользователя, затем отвечать на языке последнего сообщения пользователя

### Key Entities

- **TelegramUser**: Профиль пользователя, привязанный к Telegram ID; содержит связь с основным профилем пользователя (User), вкусовые предпочтения, историю диалогов, отметку о выполнении /start (согласие с возрастным ограничением)

- **ChatSession**: Сессия диалога с ботом; содержит историю сообщений текущей сессии, контекст для персонализации рекомендаций, связь с TelegramUser. Сессия истекает после 24 часов неактивности пользователя; новое сообщение после истечения создает новую сессию

- **Message**: Отдельное сообщение в диалоге; содержит текст сообщения, отправителя (пользователь или бот), временную метку, тип сообщения (запрос, рекомендация, системное)

- **WineRecommendation**: Рекомендация вина, сгенерированная для пользователя; содержит информацию о вине из каталога, обоснование рекомендации, контекст запроса, обратную связь от пользователя

- **UserPreference**: Вкусовые предпочтения пользователя; содержит параметры (сладость, кислотность, танины, тело, ароматы, бюджет, опыт с вином), историю обновлений

- **Wine**: Вино из каталога; содержит название, производитель, регион, сорт винограда, год урожая, вкусовые характеристики, описание, вкусовые ноты, ценовой диапазон (сущность используется совместно с веб-версией)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может начать использовать бота (найти, запустить, получить первую рекомендацию) в течение 2 минут с момента первого поиска бота в Telegram

- **SC-002**: Пользователь получает персонализированную рекомендацию вина в течение 10 секунд после отправки текстового запроса

- **SC-003**: 90% рекомендаций содержат полную информацию о вине (название, регион, сорт, год, характеристики, цена, обоснование) в читаемом формате

- **SC-004**: Информация о вине отображается на мобильном экране без горизонтальной прокрутки для 95% устройств

- **SC-005**: Система поддерживает одновременную работу 1000 пользователей через бота без деградации производительности (время ответа остается в пределах 10 секунд)

- **SC-006**: Профиль пользователя синхронизируется между ботом и веб-версией в режиме реального времени (задержка не более 5 секунд)

- **SC-007**: 95% пользователей успешно находят бота в Telegram по имени с первой попытки

- **SC-008**: Пользователь может обновить свой вкусовой профиль через бота без перехода в веб-версию, затратив не более 3 минут на диалог

- **SC-009**: Система корректно обрабатывает 100% нераспознанных команд, предоставляя понятное сообщение об ошибке и помощь

- **SC-010**: История диалогов доступна пользователю через веб-версию в течение минимум 90 дней после создания сессии

- **SC-011**: 80% пользователей оставляют обратную связь на рекомендации ("понравилось" / "не понравилось") в течение недели после получения рекомендации

- **SC-012**: Веб-сервер и Telegram-бот могут запускаться и останавливаться независимо без влияния на работоспособность системы

## Dependencies & Assumptions *(mandatory)*

### Dependencies

- **DEP-001**: Существующий каталог вин с минимум 50 винами (из US-001, SS-007)
- **DEP-002**: Работающая система персонализации (LLM + RAG) из веб-версии
- **DEP-003**: База данных пользователей PostgreSQL 16 с поддержкой профилей
- **DEP-004**: Telegram Bot API для взаимодействия с платформой Telegram
- **DEP-005**: Единый API Gateway для обслуживания запросов от веб и бота
- **DEP-006**: Система аутентификации, поддерживающая Telegram ID

### Assumptions

- **ASM-001**: Пользователи имеют доступ к Telegram и умеют пользоваться ботами
- **ASM-002**: Пользователи читают описание бота и понимают, что выполнение /start означает согласие с возрастным ограничением 18+ (юридическая ответственность на пользователе)
- **ASM-003**: Telegram Bot API остается стабильным и доступным (99% uptime)
- **ASM-004**: Пользователи могут скроллить историю сообщений в Telegram для просмотра прошлых диалогов (не требуется отдельный UI)
- **ASM-005**: Формат мессенджера предполагает текстовое взаимодействие без сложных UI-элементов
- **ASM-006**: Бот и веб-версия используют одну логику рекомендаций, поэтому качество рекомендаций идентично
- **ASM-007**: Большинство пользователей будут использовать бота с мобильных устройств (адаптация контента под мобильный формат критична)
- **ASM-008**: Telegram ID является достаточно надежным идентификатором для аутентификации в контексте мессенджера
- **ASM-009**: Пользователи не ожидают покупки вина через бота на текущем этапе (фокус на рекомендациях и образовании)
- **ASM-010**: Инфраструктура поддерживает раздельный деплой компонентов (например, бот на отдельном сервере)

## Out of Scope *(mandatory)*

### Excluded from this feature

- **OOS-001**: Покупка вина через бота (отложено на v2.0, ожидается UCP или партнерство)
- **OOS-002**: Сканирование этикеток вина через камеру (требует OCR, не критично для MVP)
- **OOS-003**: Отображение изображений бутылок вина (не критично для рекомендаций, может добавлено позже)
- **OOS-004**: Социальные функции (шаринг рекомендаций, рейтинги) через бота (фокус на персональном опыте)
- **OOS-005**: Отдельный UI для просмотра истории прошлых сессий через команды бота (пользователь скроллит в Telegram)
- **OOS-006**: Команда /reset для сброса контекста диалога (пользователь может уточнить запрос обычным сообщением)
- **OOS-007**: Интеграция с платежными системами для покупок
- **OOS-008**: Геолокация для поиска ближайших винных магазинов
- **OOS-009**: Push-уведомления о новых винах в каталоге или специальных предложениях
- **OOS-010**: Голосовые сообщения для взаимодействия с ботом (только текст)

## Technical Constraints *(optional)*

Данная секция намеренно оставлена пустой, так как спецификация фокусируется на бизнес-требованиях и не содержит технических деталей реализации.

## Clarifications

### Session 2026-02-05

- Q: Какой уровень observability требуется для MVP? → A: Минимальный — только логирование критических ошибок, без сбора метрик
- Q: Что делать, если LLM/сервис рекомендаций временно недоступен? → A: Возвращать сообщение об ошибке и предлагать попробовать позже
- Q: Когда заканчивается сессия диалога (ChatSession)? → A: После 24 часов неактивности пользователя
- Q: Нужен ли rate limiting для пользователей? → A: Нет, для MVP без ограничений
- Q: Какой язык поддерживает бот? → A: Изначально определяется по локали Telegram, затем бот отвечает на языке сообщения пользователя

## Notes *(optional)*

- **NOTE-001**: Бот использует ту же логику персонализации, что и веб-версия, обеспечивая консистентность опыта пользователя между каналами

- **NOTE-002**: Формат мессенджера накладывает естественные ограничения на UI: нет сложных форм, навигации, визуализаций. Фокус на текстовом диалоге и простых командах.

- **NOTE-003**: История сессий сохраняется в БД независимо от канала доступа (бот или веб), что позволяет пользователю переключаться между каналами без потери контекста

- **NOTE-004**: Возрастное ограничение 18+ реализовано через информацию в описании бота о том, что выполнение /start означает согласие с возрастным ограничением. Техническая верификация возраста не предусмотрена.

- **NOTE-005**: Раздельный запуск компонентов (бот/веб) обеспечивает гибкость в деплое: можно разместить бота на отдельном сервере для масштабирования или отключить один из каналов для обслуживания

- **NOTE-006**: Telegram Bot API предоставляет надежную верификацию Telegram ID через токены, что обеспечивает базовый уровень защиты от подмены без дополнительной реализации

- **NOTE-007**: Подсказки для запросов персонализированы на основе профиля пользователя и контекста (сезон, события), что снижает когнитивную нагрузку и стимулирует взаимодействие

- **NOTE-008**: Обратная связь на рекомендации ("понравилось" / "не понравилось") является ключевым механизмом улучшения персонализации и должна быть максимально простой для пользователя

- **NOTE-009**: Для MVP используется минимальный уровень observability: только логирование критических ошибок в stdout/файл, без сбора метрик и трейсинга. Расширенный мониторинг может быть добавлен в последующих версиях

- **NOTE-010**: Бот адаптирует язык ответов: при первом контакте используется локаль из Telegram-профиля пользователя, затем бот переключается на язык последнего сообщения пользователя (например, если пользователь пишет на английском — отвечаем на английском)
