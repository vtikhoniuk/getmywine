# Feature Specification: Структурированный формат сообщений с винными рекомендациями

**Feature Branch**: `012-split-wine-messages`
**Created**: 2026-02-10
**Status**: Draft
**Input**: Разбиение ответа Telegram-бота на 5 отдельных сообщений: вступление, 3 вина с фото бутылки, завершающее сообщение

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Новый пользователь получает рекомендации в структурированном формате (Priority: P1)

Новый пользователь впервые пишет боту или нажимает /start. Бот отвечает серией из 5 отдельных сообщений: приветствие с кратким описанием контекста, три предложения вин (каждое с фотографией бутылки и описанием), завершающее сообщение с предложением уточнить запрос.

**Why this priority**: Это основной сценарий взаимодействия. Первое впечатление пользователя определяет, продолжит ли он общение с ботом.

**Independent Test**: Можно протестировать, отправив /start от нового аккаунта и проверив, что бот прислал ровно 5 сообщений в правильном порядке и формате.

**Acceptance Scenarios**:

1. **Given** пользователь ранее не взаимодействовал с ботом, **When** пользователь отправляет /start или первое сообщение, **Then** бот отправляет 5 отдельных сообщений в определённой последовательности
2. **Given** бот готовит ответ новому пользователю, **When** формируется первое сообщение, **Then** оно содержит приветствие и краткое описание контекста (1–2 предложения), без изображений
3. **Given** бот формирует рекомендации, **When** отправляются сообщения 2, 3 и 4, **Then** каждое содержит фотографию бутылки вина и текстовое описание: название, регион, сорт винограда, тип, цена, почему вино подходит
4. **Given** бот отправил 3 рекомендации, **When** формируется пятое сообщение, **Then** оно содержит вопрос для продолжения диалога и уточнения предпочтений

---

### User Story 2 — Возвращающийся пользователь получает персонализированные рекомендации (Priority: P1)

Пользователь, который уже общался с ботом ранее, задаёт вопрос о вине или описывает ситуацию. Бот отвечает теми же 5 сообщениями, но без повторного приветствия — первое сообщение содержит только описание контекста запроса.

**Why this priority**: Повторные пользователи — основная аудитория. Единообразный формат ответа критически важен для удобства.

**Independent Test**: Можно протестировать, отправив повторное сообщение от существующего пользователя и проверив формат 5 сообщений без приветствия.

**Acceptance Scenarios**:

1. **Given** пользователь ранее взаимодействовал с ботом, **When** пользователь отправляет текстовый запрос (например, «подбери красное к стейку»), **Then** бот отвечает 5 сообщениями в том же формате
2. **Given** это не первое взаимодействие пользователя, **When** формируется первое сообщение, **Then** оно содержит краткое описание контекста запроса без повторного приветствия
3. **Given** у пользователя есть вкусовой профиль, **When** бот формирует рекомендации, **Then** текст описания каждого вина объясняет, почему оно подходит с учётом профиля пользователя

---

### User Story 3 — Отображение фотографии бутылки вместе с описанием вина (Priority: P1)

Каждое из трёх винных сообщений содержит фотографию бутылки, загруженную из базы данных, и текстовую подпись с ключевыми характеристиками вина.

**Why this priority**: Визуальная подача — ключевой элемент, который помогает пользователю узнать вино на полке и принять решение о покупке.

**Independent Test**: Можно протестировать, запросив рекомендации и проверив, что каждое из 3 сообщений с вином содержит изображение и подпись.

**Acceptance Scenarios**:

1. **Given** вино имеет изображение в базе данных, **When** бот формирует сообщение-рекомендацию для этого вина, **Then** сообщение отправляется как фото с текстовой подписью
2. **Given** у вина отсутствует изображение в базе данных, **When** бот формирует рекомендацию, **Then** сообщение отправляется как текст без изображения
3. **Given** бот отправляет фото вина, **When** формируется подпись к фото, **Then** подпись содержит: название вина, регион и страну, сорт винограда (если указан), тип (сухое/полусухое/и т.д.) и цену в рублях
4. **Given** подпись к фото превышает допустимую длину, **When** бот отправляет сообщение, **Then** подпись обрезается до допустимого лимита без потери ключевой информации (название, цена)

---

### User Story 4 — Корректная обработка при недоступности структурированного ответа (Priority: P2)

Если система не смогла сформировать структурированный ответ с разметкой (маркерами секций), бот должен отправить ответ в виде единого текстового сообщения и отдельных фото для каждого упомянутого вина.

**Why this priority**: Graceful degradation необходим для стабильной работы при ошибках разбора ответа.

**Independent Test**: Можно протестировать, симулировав ответ без структурных маркеров и проверив, что бот всё равно отправляет вразумительный ответ.

**Acceptance Scenarios**:

1. **Given** система вернула ответ без структурных маркеров секций, **When** бот пытается разобрать ответ, **Then** бот отправляет ответ как единое текстовое сообщение
2. **Given** бот отправил текст без структуры, **When** в тексте упомянуты вина из каталога, **Then** бот дополнительно отправляет фотографии этих вин (если изображения доступны)

---

### Edge Cases

- Что происходит, если в каталоге менее 3 вин, соответствующих запросу? Бот отправляет столько сообщений с вином, сколько найдено (от 1 до 3), сохраняя intro и closing
- Что происходит, если изображение вина повреждено или недоступно на диске? Бот отправляет описание вина как текстовое сообщение вместо фото
- Что происходит при отправке фото большого размера? Система обрабатывает изображение в допустимых рамках файлового лимита мессенджера
- Что происходит при медленном соединении пользователя? Сообщения отправляются последовательно, пользователь видит их по мере доставки
- Что происходит, если ответ содержит описание вина, которого нет в каталоге? Сообщение отправляется как текст без фотографии

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Бот ДОЛЖЕН отправлять ответ на запрос о вине в виде ровно 5 отдельных сообщений, когда доступен структурированный ответ и найдено 3 вина
- **FR-002**: Первое сообщение ДОЛЖНО содержать приветствие (для новых пользователей) или описание контекста запроса (для возвращающихся) в текстовом формате
- **FR-003**: Сообщения 2, 3 и 4 ДОЛЖНЫ содержать фотографию бутылки вина с текстовой подписью, включающей: название, регион, страну, сорт винограда, тип вина и цену
- **FR-004**: Фотографии бутылок ДОЛЖНЫ загружаться из базы данных вин, куда они были добавлены при первоначальной загрузке каталога
- **FR-005**: Пятое сообщение ДОЛЖНО содержать вопрос или предложение для уточнения контекста и продолжения диалога
- **FR-006**: Текстовая подпись к фото ДОЛЖНА быть в формате простого текста (без разметки), чтобы корректно отображаться под изображением
- **FR-007**: Текстовые сообщения (первое и пятое) ДОЛЖНЫ поддерживать базовое форматирование: жирный текст, курсив
- **FR-008**: При отсутствии изображения для конкретного вина система ДОЛЖНА отправить описание как текстовое сообщение вместо фото
- **FR-009**: При невозможности разбора структурированного ответа система ДОЛЖНА отправить ответ как единое текстовое сообщение с отдельными фото вин
- **FR-010**: Подпись к фото ДОЛЖНА содержать не более 1024 символов, при превышении — обрезаться с сохранением ключевых данных (название, цена)
- **FR-011**: Порядок отправки сообщений ДОЛЖЕН быть строго последовательным: intro → вино 1 → вино 2 → вино 3 → closing
- **FR-012**: При нахождении менее 3 вин система ДОЛЖНА отправлять сообщения только для найденных вин, сохраняя intro и closing

### Key Entities

- **Вино (Wine)**: Запись в каталоге, содержащая: название, производитель, год, страна, регион, сорт винограда, тип, сладость, цена, описание, ссылка на изображение бутылки
- **Изображение бутылки (Wine Image)**: Файл изображения, хранящийся локально, привязанный к записи вина через поле image_url. Загружается при первоначальном наполнении каталога
- **Структурированный ответ (Structured Response)**: Ответ системы, разбитый на секции: вступление (intro), описания вин (wines 1–3), завершение (closing)
- **Вкусовой профиль (Taste Profile)**: Совокупность предпочтений пользователя, влияющая на персонализацию рекомендаций и объяснения выбора вин

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% ответов с рекомендациями отправляются в формате 5 отдельных сообщений (при наличии 3 вин и успешном разборе ответа)
- **SC-002**: Каждое из 3 сообщений с вином содержит фотографию бутылки в не менее чем 90% случаев (остальные 10% — вина без загруженного изображения)
- **SC-003**: Пользователь получает все 5 сообщений в течение 15 секунд после отправки запроса
- **SC-004**: В 100% случаев, когда структурированный ответ недоступен, пользователь получает fallback-ответ с текстом и фотографиями
- **SC-005**: Текстовая подпись к фото во всех случаях содержит минимум: название вина и цену

## Assumptions

- Изображения бутылок загружаются при первоначальном наполнении каталога вин и хранятся локально
- У большинства вин в каталоге (>90%) есть загруженное изображение бутылки
- Формат фотографий — PNG, размер достаточен для отображения в мессенджере без дополнительной обработки
- Лимит подписи к фото в мессенджере составляет 1024 символа
- Система рекомендует ровно 3 вина на каждый запрос (стандартное поведение)
- Первое и пятое сообщения используют базовое форматирование (жирный, курсив)
- Последовательная отправка сообщений не вызывает проблем с rate-limiting мессенджера при стандартной нагрузке

## Out of Scope

- Изменение содержания рекомендаций (алгоритм подбора вин не затрагивается)
- Добавление кнопок, инлайн-клавиатур или других интерактивных элементов
- Изменение формата хранения изображений или их загрузка из внешних источников
- Поддержка видео, GIF или других медиа-форматов помимо статических изображений
- Изменение количества рекомендуемых вин (всегда 3)
- Групповые чаты или каналы — только личные сообщения
