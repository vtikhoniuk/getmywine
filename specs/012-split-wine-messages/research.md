# Research: 012-split-wine-messages

**Date**: 2026-02-10
**Feature**: Структурированный формат сообщений с винными рекомендациями

## Ключевой вывод

Функционал 5-message формата **уже реализован** в текущей кодовой базе. Основная работа по этой фиче — формализация, тестирование и рефакторинг существующего кода.

## Текущее состояние реализации

### Реализованные компоненты

| Компонент | Файл | Статус |
|-----------|------|--------|
| Парсинг структурированного ответа | `sommelier_prompts.py:parse_structured_response()` | Реализован |
| Отправка 5 сообщений (/start) | `handlers/start.py:start_command()` | Реализован |
| Отправка 5 сообщений (message) | `handlers/message.py:_send_structured()` | Реализован |
| Fallback на единое сообщение | `handlers/message.py`, `handlers/start.py` | Реализован |
| Резолв изображений | `utils.py:get_wine_image_path()` | Реализован |
| Sanitization Markdown для Telegram | `utils.py:sanitize_telegram_markdown()` | Реализован |
| Удаление Markdown для caption | `sommelier_prompts.py:strip_markdown()` | Реализован |
| Форматирование caption для фото | `formatters.py:format_wine_photo_caption()` | Реализован (используется в fallback) |
| LLM-промпты с маркерами | `sommelier_prompts.py:SYSTEM_PROMPT_BASE` | Реализован |

### Нереализованные компоненты

| Компонент | Причина | Приоритет |
|-----------|---------|-----------|
| Тесты для парсинга структурированного ответа | Отсутствуют полностью | Высокий |
| Тесты для обработчиков бота | Отсутствуют полностью | Высокий |
| Тесты для утилит (image path, markdown) | Отсутствуют полностью | Высокий |
| Рефакторинг дублирования start.py / message.py | Одинаковая логика отправки | Средний |

## Исследование 1: Дублирование логики отправки

**Проблема**: Логика отправки 5 сообщений дублируется между `start.py` и `message.py`. Оба файла содержат почти идентичный код:
- Вызов `parse_structured_response()`
- Цикл по `parsed.wines` с отправкой фото
- Fallback на текст при отсутствии изображения

**Decision**: Вынести общую логику отправки в отдельную утилитарную функцию
**Rationale**: Устраняет дублирование, снижает риск расхождения поведения между /start и обычными сообщениями
**Alternatives considered**:
- Оставить как есть — отвергнуто, т.к. нарушает DRY и затрудняет тестирование
- Создать отдельный класс MessageSender — избыточно для одной функции

## Исследование 2: Стратегия тестирования

**Проблема**: Нет ни одного теста для bot-хендлеров, парсинга, утилит.

**Decision**: Добавить unit-тесты для:
1. `parse_structured_response()` — парсинг маркеров (полный, частичный, пустой)
2. `strip_markdown()` — удаление разметки
3. `sanitize_telegram_markdown()` — конвертация для Telegram
4. `get_wine_image_path()` — резолв путей к изображениям
5. `format_wine_photo_caption()` — формат подписи к фото
6. `_send_structured()` — интеграционный тест с мокированным Telegram API

**Rationale**: Конституция требует TDD и 100% покрытие критичных путей. Парсинг и отправка сообщений — критичный путь.
**Alternatives considered**:
- E2E-тесты с реальным Telegram API — отвергнуто, слишком хрупкие и медленные
- Только тесты парсинга — недостаточно, не покрывает отправку

## Исследование 3: Telegram Bot API — ограничения

**Decision**: Текущая реализация корректно учитывает ограничения:
- Caption limit: 1024 символа (обрезка реализована)
- Parse mode: Markdown v1 для текста, plain text для caption
- Rate limiting: Telegram допускает ~30 сообщений/сек в личных чатах, 5 последовательных сообщений не вызовут проблем

**Rationale**: Проверено по документации Telegram Bot API
**Alternatives considered**: MarkdownV2 — отвергнуто, требует экранирования спецсимволов, усложняет код
