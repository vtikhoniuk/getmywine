# Feature Specification: Расширенные ответы на околовинные темы

**Feature Branch**: `019-expand-wine-responses`
**Created**: 2026-02-12
**Status**: Draft
**Input**: User description: "Сейчас бот, если его спросить на винную тему, но не непосредственно про вино (винные регионы, технологии производств и пр.), отвечает очень кратно. Нужно немного шире отвечать: 5-10 предложений + подводка к тому, чтобы вернуться к обсуждению вин."

## Clarifications

### Session 2026-02-12

- Q: Что считать «одной сессией» для контроля разнообразия подводок (FR-004, SC-003)? → A: Контекстное окно LLM — подводки не должны повторяться в пределах истории сообщений, передаваемой модели
- Q: Насколько строго подводка должна быть привязана к теме вопроса? → A: Всегда тематическая — подводка конкретно связана с обсуждаемой темой (Тоскана → тосканские вина, малолактика → вина с яркой малолактикой)
- Q: Нужно ли тегировать расширенные околовинные ответы в Langfuse для аналитики? → A: Да, околовинные ответы получают отдельный тег/метаданные в Langfuse для измерения качества и влияния изменений

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Развёрнутый ответ на околовинный вопрос (Priority: P1)

Пользователь спрашивает бота о теме, связанной с вином, но не о конкретном вине — например, о винодельческом регионе, технологии производства, сортах винограда, истории виноделия или культуре потребления. Бот отвечает развёрнуто (5-10 предложений), раскрывая тему информативно и интересно, а в конце делает естественную подводку к обсуждению конкретных вин, связанных с заданной темой.

**Why this priority**: Это основной сценарий фичи — улучшение качества ответов на околовинные вопросы. Без него фича не имеет смысла.

**Independent Test**: Можно протестировать, отправив боту вопрос вроде «Расскажи про Бордо как винный регион» и убедившись, что ответ содержит 5-10 предложений с подводкой к обсуждению вин.

**Acceptance Scenarios**:

1. **Given** пользователь ведёт диалог с ботом, **When** пользователь спрашивает «Что такое малолактическая ферментация?», **Then** бот отвечает развёрнуто (5-10 предложений), объясняя суть процесса, и завершает ответ подводкой к обсуждению вин (например, «Кстати, хотите подобрать вино, где малолактика особенно хорошо раскрывается?»)
2. **Given** пользователь ведёт диалог с ботом, **When** пользователь спрашивает «Расскажи про Тоскану», **Then** бот отвечает 5-10 предложениями о Тоскане как винном регионе и предлагает перейти к обсуждению конкретных тосканских вин
3. **Given** пользователь ведёт диалог с ботом, **When** пользователь спрашивает «Чем отличается органическое виноделие?», **Then** бот даёт развёрнутый ответ о принципах органического виноделия и предлагает обсудить конкретные органические вина

---

### User Story 2 - Подводка к обсуждению вин остаётся ненавязчивой (Priority: P2)

Пользователь задаёт несколько околовинных вопросов подряд. Бот каждый раз отвечает развёрнуто и предлагает перейти к обсуждению вин, но подводки не повторяются дословно и не создают ощущения навязчивости. Если пользователь продолжает задавать вопросы на околовинные темы, бот продолжает отвечать на них так же качественно.

**Why this priority**: Важно, чтобы подводка к обсуждению вин воспринималась как естественная, а не как повторяющийся скрипт. Это влияет на удовлетворённость пользователя.

**Independent Test**: Можно протестировать, отправив 3 околовинных вопроса подряд и убедившись, что подводки в каждом ответе отличаются.

**Acceptance Scenarios**:

1. **Given** пользователь задал 3 околовинных вопроса подряд, **When** бот отвечает на каждый из них, **Then** подводки к обсуждению вин в каждом ответе отличаются формулировкой
2. **Given** пользователь игнорирует подводку и задаёт следующий околовинный вопрос, **When** бот отвечает, **Then** бот не упрекает пользователя и не настаивает на переходе к вину, а просто отвечает на вопрос с новой подводкой

---

### Edge Cases

- Что происходит, если вопрос находится на грани между «про вино» и «около вина» (например, «Какие сорта винограда растут в Бургундии?»)? Бот должен отвечать развёрнуто, так как вопрос скорее о регионе/сортах, чем о конкретном вине.
- Что происходит, если пользователь задаёт вопрос на совсем не винную тему (например, «Какая погода в Париже?»)? Поведение бота на не-винные темы не меняется — это вне скоупа данной фичи.
- Что происходит, если околовинный вопрос очень узкий и на него нельзя ответить 5-10 предложениями (например, «В каком году основано шато Марго?»)? Бот отвечает настолько развёрнуто, насколько позволяет тема, но не «льёт воду» ради количества предложений. Минимум — 3 предложения.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Бот ДОЛЖЕН распознавать околовинные вопросы (винные регионы, сорта винограда, технологии производства, история виноделия, культура потребления, винная терминология) и отличать их от вопросов непосредственно о конкретных винах
- **FR-002**: На околовинные вопросы бот ДОЛЖЕН отвечать развёрнуто — от 3 до 10 предложений в зависимости от глубины темы
- **FR-003**: Каждый ответ на околовинный вопрос ДОЛЖЕН содержать в конце тематическую подводку к обсуждению конкретных вин, непосредственно связанных с темой вопроса (например, вопрос о Тоскане → предложение обсудить тосканские вина, а не абстрактное «хотите подобрать вино?»)
- **FR-004**: Подводки к обсуждению вин ДОЛЖНЫ быть разнообразными — бот не должен использовать одну и ту же формулировку в пределах контекстного окна LLM (т.е. в рамках истории сообщений, передаваемой модели)
- **FR-005**: Бот НЕ ДОЛЖЕН «лить воду» ради достижения объёма — если тема узкая, допускается ответ из 3 предложений с подводкой
- **FR-006**: Поведение бота при ответах непосредственно о конкретных винах НЕ ДОЛЖНО меняться
- **FR-007**: Поведение бота при ответах на не-винные темы НЕ ДОЛЖНО меняться
- **FR-008**: Ответы на околовинные вопросы ДОЛЖНЫ тегироваться в системе мониторинга (Langfuse) отдельным тегом для возможности аналитики качества и измерения влияния изменений

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Ответы бота на околовинные вопросы содержат в среднем 6-8 предложений (вместо текущих 1-2)
- **SC-002**: 100% ответов на околовинные вопросы содержат подводку к обсуждению конкретных вин
- **SC-003**: При 3 последовательных околовинных вопросах в пределах одного контекстного окна LLM ни одна подводка не повторяется дословно
- **SC-004**: Ответы на вопросы непосредственно о конкретных винах остаются без изменений (регрессии отсутствуют)
- **SC-005**: Пользователи оценивают ответы на околовинные вопросы как информативные и полезные (качественная метрика при ручном ревью)

## Assumptions

- Бот уже умеет различать винные и не-винные темы на базовом уровне; эта фича уточняет поведение внутри «винных» тем
- Текущее краткое поведение на околовинные вопросы обусловлено промптом/инструкциями, а не ограничениями модели
- Подводка к обсуждению вин является мягким предложением, а не обязательным переходом — пользователь волен продолжать задавать околовинные вопросы
- Под «конкретными винами» понимаются вопросы типа «Посоветуй вино к пасте» или «Что скажешь про Barolo 2018?», а под «околовинными» — «Расскажи про Пьемонт», «Что такое танины?», «Как делают игристое вино?»
