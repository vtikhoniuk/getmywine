# Feature Specification: Нормализация названий вин и отображение изображений

**Feature Branch**: `013-normalize-wine-names`
**Created**: 2026-02-10
**Status**: Draft
**Input**: Нормализация названий вин в каталоге: убрать префикс «Вино», производителя и год из поля name в wines_seed.json и БД. Улучшение отображения изображений вин в Telegram-боте: ресайз, белый фон, настраиваемая высота.

## Clarifications

### Session 2026-02-10

- Q: Должны ли все три префикса (Вино, Игристое вино, Шампанское) удаляться из name? → A: Да, все три префикса удаляются; wine_type хранит тип отдельно
- Q: Должна ли логика сопоставления вин с LLM-ответами быть упрощена после нормализации? → A: Да, упростить до прямого поиска по нормализованному name (удалить 3-уровневый workaround)
- Q: Что должно происходить при недоступности API эмбеддингов во время миграции? → A: Двухфазная миграция: names обновляются всегда, эмбеддинги пересчитываются отдельным шагом (может быть отложен)

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Чистые названия вин в каталоге (Priority: P1)

Администратор загружает каталог вин из seed-данных. Поле `name` каждого вина содержит только собственное название (например, «Malbec» или «Петрикор Красное»), без категорийного префикса («Вино», «Игристое вино», «Шампанское»), без имени производителя и без года урожая. Производитель, год, регион и страна хранятся в соответствующих отдельных полях. Это устраняет дублирование данных и упрощает сопоставление вин с упоминаниями в ответах LLM.

**Why this priority**: Без нормализации names LLM-сервис не может надёжно сопоставить рекомендованные вина с каталогом — пользователь не видит фотографии бутылок. Это корневая причина основного бага.

**Independent Test**: Запустить миграцию с обновлёнными seed-данными → проверить, что для всех 50 вин поле name не начинается с «Вино» / «Игристое вино» / «Шампанское» и не содержит года урожая или имени производителя.

**Acceptance Scenarios**:

1. **Given** wines_seed.json с нормализованными названиями, **When** запускается миграция/ресид, **Then** каждое вино в БД имеет name без категорийного префикса («Вино» / «Игристое вино» / «Шампанское»), без producer и без vintage_year
2. **Given** вино с именем «Malbec» (producer=«Luigi Bosca», vintage_year=2024), **When** LLM упоминает «Malbec» в ответе, **Then** система сопоставляет это упоминание с вином и показывает фото бутылки
3. **Given** вино с именем «Петрикор Красное» (producer=«Шумринка»), **When** LLM упоминает «Петрикор Красное» в ответе, **Then** система сопоставляет это с вином из каталога
4. **Given** нормализованные названия, **When** пользователь запрашивает рекомендацию в Telegram, **Then** бот находит 3 вина и отправляет их с фотографиями

---

### User Story 2 — Корректное отображение фото бутылок в Telegram (Priority: P1)

Пользователь получает рекомендацию вина в Telegram. Фотография бутылки отображается аккуратно: бутылка уменьшена, отцентрирована по горизонтали на белом фоне, занимает всю ширину сообщения. Высота фото настраивается через переменную окружения.

**Why this priority**: Визуальное качество фото бутылок напрямую влияет на восприятие рекомендации пользователем. Без обработки изображение бутылки выглядит слишком большим и не вписывается в чат.

**Independent Test**: Отправить запрос боту → получить рекомендацию с фото → проверить, что фото имеет белый фон, бутылка отцентрирована, высота соответствует настройке.

**Acceptance Scenarios**:

1. **Given** вино с изображением бутылки в каталоге, **When** бот отправляет рекомендацию, **Then** изображение масштабировано до целевой высоты с сохранением пропорций и размещено по центру на белом фоне шириной 800px
2. **Given** переменная окружения TELEGRAM_WINE_PHOTO_HEIGHT=460, **When** бот обрабатывает фото бутылки высотой 920px, **Then** бутылка масштабируется до 460px высоты
3. **Given** переменная окружения TELEGRAM_WINE_PHOTO_HEIGHT изменена на 300, **When** бот перезапущен и отправляет фото, **Then** высота бутылки на итоговом изображении — 300px

---

### User Story 3 — Проверка полноты структурированных данных каталога (Priority: P2)

Все характеристики вин (регион, страна, производитель, год, сорт винограда, тип, сладость, кислотность, танины, тело, описание, цена) заполнены в соответствующих полях таблицы wines и не дублируются в name. При отображении подписи к фото в Telegram бот формирует полную подпись из отдельных полей, а не из name.

**Why this priority**: Корректное разделение данных по полям — основа для будущих фильтров, поиска и персонализации. Без этого качество рекомендаций ограничено.

**Independent Test**: Загрузить каталог → для каждого из 50 вин проверить, что все обязательные поля заполнены и name не содержит данных из других полей.

**Acceptance Scenarios**:

1. **Given** 50 вин в каталоге, **When** проверяется seed-файл, **Then** у каждого вина заполнены: name, producer, vintage_year, country, region, grape_varieties, wine_type, sweetness, price_rub
2. **Given** вино с name=«Chianti Castiglioni» (producer=«Frescobaldi», vintage_year=2024, region=«Тоскана», country=«Италия»), **When** бот формирует подпись к фото, **Then** подпись содержит все данные из отдельных полей в читаемом формате

---

### Edge Cases

- Что происходит, если название вина само по себе содержит цифры, похожие на год (например, «Cuvée 1858»)? — Год удаляется только из конца строки name и только если он совпадает с vintage_year
- Что происходит, если producer входит в название вина (например, «Barbera d'Asti Luca Bosio» где Luca Bosio — и название, и producer)? — В таких случаях name сохраняет полную форму «Barbera d'Asti Luca Bosio», producer хранится отдельно
- Что происходит, если изображение бутылки отсутствует? — Рекомендация отправляется как текстовое сообщение без фото (уже реализовано)
- Что происходит, если TELEGRAM_WINE_PHOTO_HEIGHT не задана? — Используется значение по умолчанию (460px)
- Что происходит, если API эмбеддингов недоступен после обновления names? — Названия обновляются в БД; пересчёт эмбеддингов откладывается до доступности API. Семантический поиск может временно работать некорректно

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА хранить в поле name таблицы wines только собственное название вина, без категорийного префикса («Вино», «Игристое вино», «Шампанское»), без имени производителя и без года урожая
- **FR-002**: Система ДОЛЖНА хранить производителя, год урожая, регион, страну и сорт винограда в отдельных полях таблицы wines (producer, vintage_year, region, country, grape_varieties)
- **FR-003**: Seed-данные (wines_seed.json) ДОЛЖНЫ содержать нормализованные названия — только собственное имя вина в поле name
- **FR-004**: Миграция ДОЛЖНА обновить существующие записи в БД, заменив старые названия (с префиксом «Вино», producer и vintage) на нормализованные
- **FR-005**: Пересчёт эмбеддингов ДОЛЖЕН выполняться как отдельный шаг (не в Alembic-миграции), чтобы обновление names не блокировалось недоступностью API эмбеддингов. Миграция names и пересчёт эмбеддингов — две независимые фазы
- **FR-006**: Система ДОЛЖНА сопоставлять вина из каталога с упоминаниями в ответах LLM по прямому поиску нормализованного name в тексте ответа. Существующая 3-уровневая логика обхода (strip «Вино», strip year) ДОЛЖНА быть заменена на прямое сопоставление
- **FR-007**: Telegram-бот ДОЛЖЕН при отправке фото бутылки масштабировать изображение до целевой высоты (сохраняя пропорции) и размещать его по центру на белом фоне шириной 800px
- **FR-008**: Целевая высота фото бутылки ДОЛЖНА настраиваться через переменную окружения TELEGRAM_WINE_PHOTO_HEIGHT (по умолчанию 460px)
- **FR-009**: Подпись к фото бутылки ДОЛЖНА формироваться из отдельных полей wine (name, region, country, grape_varieties, sweetness, price_rub), а не из поля name целиком

### Key Entities

- **Wine**: Центральная сущность каталога. Ключевые атрибуты: name (только название), producer, vintage_year, country, region, grape_varieties, wine_type, sweetness, price_rub, image_url. Связь: используется SommelierService для рекомендаций
- **wines_seed.json**: Источник seed-данных каталога. 50 вин с полными характеристиками. Изменяется: нормализация name

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% вин в каталоге имеют name без категорийного префикса («Вино» / «Игристое вино» / «Шампанское»), без producer и без vintage_year
- **SC-002**: При запросе рекомендации в Telegram бот сопоставляет 3 из 3 рекомендованных вин с записями каталога (показывает фото для каждого)
- **SC-003**: Фото бутылок в Telegram имеют белый фон и бутылку по центру с целевой высотой ±1px от настройки
- **SC-004**: Все обязательные поля (producer, vintage_year, region, country, grape_varieties) заполнены для 100% вин в каталоге
- **SC-005**: Семантический поиск по описанию вин работает корректно после пересчёта эмбеддингов

## Assumptions

- Текущий формат name использует три категорийных префикса: «Вино» (42 вина), «Игристое вино» (7), «Шампанское» (1). Структура варьируется: 4 паттерна (стандартный с producer через запятую, producer встроен в name, без vintage_year с producer через запятую, без vintage_year с producer встроенным). 6 вин не имеют vintage_year (NV)
- Producer и vintage_year уже заполнены в отдельных полях для всех вин — нужна только нормализация name
- Обработка изображений (ресайз + белый фон) уже реализована в sender.py — в спеке фиксируется как требование
- Переменная окружения TELEGRAM_WINE_PHOTO_HEIGHT уже добавлена в config.py и docker-compose.yml
- Пересчёт эмбеддингов требует доступа к OpenRouter/OpenAI API
