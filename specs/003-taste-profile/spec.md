# Feature Specification: Taste Profile Discovery

**Feature Branch**: `003-taste-profile`
**Created**: 2026-02-02
**Status**: Draft
**Input**: EPIC-002: Изучение вкусового профиля. US-004, US-005, US-006, US-007, SS-001.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Skip Onboarding Survey (Priority: P1)

Пользователь хочет сразу начать пользоваться сервисом без прохождения опроса о предпочтениях. При пропуске создаётся пустой вкусовой профиль, AI предупреждает о менее точных рекомендациях и предлагает пройти опрос позже.

**Why this priority**: Снижает барьер входа — пользователь может оценить сервис без обязательств. Профиль будет формироваться естественно из диалогов.

**Independent Test**: Можно протестировать, пропустив опрос и убедившись, что создан пустой профиль и AI выдаёт предупреждение.

**Acceptance Scenarios**:

1. **Given** пользователь начинает онбординг, **When** нажимает "Пропустить", **Then** создаётся пустой вкусовой профиль
2. **Given** пользователь пропустил опрос, **When** AI обращается к нему, **Then** AI предупреждает о менее точных рекомендациях
3. **Given** пользователь пропустил опрос, **When** находится в чате, **Then** доступна возможность пройти опрос в любой момент

---

### User Story 2 - Taste Preferences Interview (Priority: P1)

GetMyWine ведёт дружеский диалог о вкусовых предпочтениях пользователя. Это не анкета с галочками, а живой разговор. AI спрашивает о предпочтениях (сладкое/сухое, лёгкое/насыщенное), об опыте с вином, о любимых продуктах и вкусах.

**Why this priority**: Ключевая функция для персонализации. Качественный профиль = качественные рекомендации.

**Independent Test**: Можно протестировать, пройдя диалог и проверив, что система сохранила предпочтения в профиле.

**Acceptance Scenarios**:

1. **Given** пользователь начинает опрос, **When** AI задаёт вопрос о сладости/сухости, **Then** пользователь может ответить свободным текстом или выбрать из предложенных вариантов
2. **Given** AI задал вопрос, **When** пользователь отвечает "не знаю", **Then** AI предлагает упрощённые варианты или примеры
3. **Given** AI спрашивает об опыте, **When** пользователь отвечает, **Then** AI адаптирует сложность последующих вопросов
4. **Given** AI спрашивает о любимых продуктах, **When** пользователь называет продукты, **Then** AI связывает их с винными характеристиками

---

### User Story 3 - Memorable Wine Description (Priority: P2)

Пользователь может описать запомнившееся вино своими словами, даже если не помнит название. AI извлекает характеристики из описания, уточняет детали и фиксирует впечатление (понравилось/не понравилось).

**Why this priority**: Ценная информация для профиля, но не обязательна для начала работы.

**Independent Test**: Можно протестировать, описав вино ("красное из Италии, пили на отпуске") и проверив, что AI извлёк характеристики.

**Acceptance Scenarios**:

1. **Given** пользователь описывает вино словами, **When** AI анализирует описание, **Then** AI извлекает возможные характеристики (регион, тип, примерные ноты)
2. **Given** описание неполное, **When** AI нуждается в уточнении, **Then** AI задаёт наводящие вопросы
3. **Given** AI извлёк характеристики, **When** спрашивает о впечатлении, **Then** пользователь отмечает понравилось/не понравилось/не помню
4. **Given** впечатление зафиксировано, **When** профиль обновляется, **Then** характеристики влияют на будущие рекомендации

---

### User Story 4 - Budget Preferences (Priority: P2)

AI спрашивает типичный бюджет пользователя на бутылку вина. Бюджет влияет на рекомендации, но не ограничивает их жёстко.

**Why this priority**: Важно для релевантности рекомендаций, но можно работать и без этой информации.

**Independent Test**: Можно протестировать, указав бюджет и проверив, что он сохранён в профиле.

**Acceptance Scenarios**:

1. **Given** AI спрашивает о бюджете, **When** пользователь выбирает диапазон, **Then** бюджет сохраняется в профиле
2. **Given** доступные диапазоны, **When** пользователь выбирает, **Then** варианты: до 500р, 500-1000р, 1000-2000р, 2000-5000р, 5000р+
3. **Given** бюджет установлен, **When** пользователь хочет изменить, **Then** бюджет можно обновить в любой момент
4. **Given** пользователь не указал бюджет, **When** AI даёт рекомендации, **Then** рекомендации включают вина разных ценовых категорий

---

### User Story 5 - Profile Auto-Update (Priority: P1)

Система автоматически обновляет вкусовой профиль пользователя после каждого взаимодействия в чате. Профиль включает: сладость, кислотность, танины, тело, предпочитаемые ароматы.

**Why this priority**: Критично для персонализации. Без обновления профиля рекомендации не улучшаются со временем.

**Independent Test**: Можно протестировать, отправив несколько сообщений о предпочтениях и проверив, что профиль обновился.

**Acceptance Scenarios**:

1. **Given** пользователь ведёт диалог с AI, **When** упоминает предпочтение, **Then** система извлекает и сохраняет информацию
2. **Given** профиль обновляется, **When** система анализирует сообщение, **Then** обновляются соответствующие параметры: сладость, кислотность, танины, тело, ароматы
3. **Given** параметр профиля обновлён, **When** система оценивает уверенность, **Then** каждый параметр имеет оценку уверенности (насколько точно известно предпочтение)
4. **Given** накоплены данные, **When** пользователь запрашивает рекомендации, **Then** рекомендации учитывают актуальный профиль

---

### Edge Cases

- Что происходит, если пользователь даёт противоречивые ответы? → AI уточняет: "Ранее вы говорили X, а сейчас Y. Что ближе к истине?"
- Что происходит, если пользователь отвечает "всё равно" на все вопросы? → AI завершает опрос с базовым профилем, отмечает низкую уверенность
- Что происходит при очень длинном описании вина? → AI выделяет ключевые детали, игнорирует нерелевантную информацию
- Что происходит, если пользователь меняет бюджет резко? → Система принимает новое значение без вопросов

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА позволять пропустить опрос о предпочтениях при онбординге
- **FR-002**: При пропуске опроса система ДОЛЖНА создавать пустой вкусовой профиль
- **FR-003**: AI ДОЛЖЕН предупреждать о менее точных рекомендациях при пустом профиле
- **FR-004**: Система ДОЛЖНА позволять начать/продолжить опрос в любой момент
- **FR-005**: AI ДОЛЖЕН вести диалог о предпочтениях в дружеском тоне, не как анкету
- **FR-006**: AI ДОЛЖЕН спрашивать о предпочтениях: сладость, кислотность, тело вина, опыт с вином
- **FR-007**: AI ДОЛЖЕН спрашивать о любимых продуктах и вкусах для построения профиля
- **FR-008**: AI ДОЛЖЕН предлагать варианты ответов, если пользователь затрудняется
- **FR-009**: Пользователь ДОЛЖЕН иметь возможность описать запомнившееся вино свободным текстом
- **FR-010**: AI ДОЛЖЕН извлекать характеристики вина из свободного описания
- **FR-011**: AI ДОЛЖЕН уточнять детали, если описание неполное
- **FR-012**: AI ДОЛЖЕН фиксировать впечатление пользователя о вине (понравилось/не понравилось/не помню)
- **FR-013**: AI ДОЛЖЕН спрашивать типичный бюджет на бутылку вина
- **FR-014**: Система ДОЛЖНА предлагать диапазоны бюджета: до 500р, 500-1000р, 1000-2000р, 2000-5000р, 5000р+
- **FR-015**: Бюджет ДОЛЖЕН быть изменяемым в любой момент
- **FR-016**: Система ДОЛЖНА автоматически обновлять профиль после каждого взаимодействия
- **FR-017**: Вкусовой профиль ДОЛЖЕН включать: сладость, кислотность, танины, тело, предпочитаемые ароматы
- **FR-018**: Система ДОЛЖНА оценивать уверенность для каждого параметра профиля

### Key Entities

- **TasteProfile**: Вкусовой профиль пользователя. Атрибуты: сладость (шкала), кислотность (шкала), танины (шкала), тело (шкала), предпочитаемые ароматы (список), бюджет (диапазон), опыт с вином (уровень). Связан с User (1:1).
- **ProfileParameter**: Отдельный параметр профиля. Атрибуты: значение, уверенность (0-1), дата последнего обновления.
- **WineMemory**: Запомнившееся вино пользователя. Атрибуты: описание, извлечённые характеристики, впечатление, контекст (где/когда пили). Связан с User (N:1).
- **OnboardingState**: Состояние прохождения опроса. Атрибуты: пройден/пропущен/в процессе, текущий шаг, дата.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 80% пользователей завершают опрос о предпочтениях или сознательно пропускают его
- **SC-002**: Среднее время прохождения опроса не превышает 5 минут
- **SC-003**: 70% пользователей, прошедших опрос, имеют профиль с уверенностью > 0.5 по минимум 3 параметрам
- **SC-004**: AI корректно извлекает минимум 2 характеристики из свободного описания вина в 85% случаев
- **SC-005**: Профиль обновляется после каждого релевантного сообщения (100% покрытие)
- **SC-006**: Пользователи с заполненным профилем получают более релевантные рекомендации (валидируется через обратную связь)

## Assumptions

- Опрос интегрирован в существующий чат-интерфейс (US-002)
- Пользователь уже авторизован (US-001)
- AI-сервис (mock на данном этапе) способен вести контекстный диалог
- Диапазоны бюджета в рублях актуальны для целевой аудитории
- Профиль хранится бессрочно

## Out of Scope

- Рекомендации вин на основе профиля (EPIC-003, US-008+)
- Интеграция с реальным LLM — используется mock
- Импорт данных из внешних сервисов (Vivino, etc.)
- Голосовой ввод предпочтений
