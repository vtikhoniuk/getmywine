# Feature Specification: Набор eval-тестов для проверки качества ответов LLM

**Feature Branch**: `016-llm-eval-tests`
**Created**: 2026-02-10
**Status**: Draft
**Input**: Формализация набора golden query тестов для проверки качества ответов LLM сомелье-бота

## Контекст

Винный сомелье-бот GetMyWine использует LLM с agentic RAG (tool use) для рекомендации вин. LLM принимает сообщение пользователя и решает, какой инструмент вызвать:
- **search_wines** — структурированный SQL-поиск (тип, сладость, сорт, цена, страна, сочетание с блюдами)
- **semantic_search** — семантический поиск по pgvector (настроение, описание вкуса)

Текущие unit-тесты покрывают логику выполнения инструментов (фильтры, broadening, enum-валидация), но не проверяют качество принятия решений самой LLM: правильность выбора инструмента, точность извлечения фильтров, отсутствие галлюцинаций, релевантность семантического поиска.

## User Scenarios & Testing *(mandatory)*

### User Story 1 — Проверка выбора инструмента (Priority: P1)

Разработчик запускает eval-тесты, чтобы убедиться, что LLM выбирает правильный инструмент для каждого типа запроса: конкретные параметры → search_wines, абстрактные описания → semantic_search.

**Why this priority**: Неправильный выбор инструмента — корневая причина всех остальных проблем (пустые результаты, галлюцинации, нерелевантные рекомендации).

**Independent Test**: Запуск `tests/eval/test_tool_selection.py` с 8 golden queries — каждый проверяет первый вызванный инструмент.

**Acceptance Scenarios**:

1. **Given** запрос "красное сухое до 2000 рублей", **When** LLM обрабатывает его, **Then** первый вызванный инструмент — search_wines
2. **Given** запрос "что-то элегантное и лёгкое", **When** LLM обрабатывает его, **Then** первый вызванный инструмент — semantic_search
3. **Given** запрос "пино нуар", **When** LLM обрабатывает его, **Then** вызывается search_wines с grape_variety
4. **Given** запрос "вино к стейку", **When** LLM обрабатывает его, **Then** вызывается search_wines с food_pairing

---

### User Story 2 — Проверка точности извлечения фильтров (Priority: P1)

Разработчик запускает eval-тесты, чтобы убедиться, что LLM корректно извлекает структурированные фильтры из естественного языка пользователя.

**Why this priority**: Неточные фильтры приводят к нерелевантным рекомендациям — основной показатель качества бота.

**Independent Test**: Запуск `tests/eval/test_filter_accuracy.py` с 3 golden queries — каждый проверяет конкретные извлечённые параметры.

**Acceptance Scenarios**:

1. **Given** запрос "красное сухое до 2000 рублей", **When** LLM вызывает search_wines, **Then** аргументы содержат wine_type=red, sweetness=dry, price_max≈2000
2. **Given** запрос "хочу попробовать мальбек", **When** LLM вызывает search_wines, **Then** аргументы содержат grape_variety с "мальбек"
3. **Given** запрос "итальянское красное", **When** LLM вызывает search_wines, **Then** аргументы содержат wine_type=red и country-фильтр

---

### User Story 3 — Обнаружение галлюцинаций (Priority: P1)

Разработчик запускает eval-тесты, чтобы убедиться, что LLM не выдумывает вина, которых нет в каталоге, а рекомендует только те, что вернул инструмент.

**Why this priority**: Галлюцинированные вина — критическая ошибка, подрывающая доверие пользователя к боту.

**Independent Test**: Запуск `tests/eval/test_hallucination.py` с 3 запросами — каждый проверяет, что все упомянутые вина существуют в каталоге.

**Acceptance Scenarios**:

1. **Given** запрос "красное сухое до 3000 рублей", **When** LLM формирует ответ, **Then** каждое вино в секциях [WINE:N] существует в каталоге
2. **Given** запрос "белое к рыбе", **When** LLM формирует ответ, **Then** ни одно вино не выдумано
3. **Given** запрос "что-нибудь из Италии", **When** инструмент возвращает 0 результатов, **Then** LLM честно сообщает об отсутствии, а не придумывает

---

### User Story 4 — Проверка качества семантического поиска (Priority: P2)

Разработчик запускает eval-тесты, чтобы убедиться, что семантический поиск (pgvector embeddings) возвращает релевантные результаты с приемлемыми показателями сходства.

**Why this priority**: Семантический поиск — ключевая функция для абстрактных запросов, но его качество менее критично, чем точность фильтров и отсутствие галлюцинаций.

**Independent Test**: Запуск `tests/eval/test_semantic_quality.py` с 5 тестами — проверка релевантности, порядка и дифференциации результатов.

**Acceptance Scenarios**:

1. **Given** запрос "вино для романтического ужина", **When** выполняется семантический поиск, **Then** возвращается >= 1 вино с similarity > 0.15
2. **Given** два разных по смыслу запроса ("ягодные ноты" vs "минеральное белое"), **When** выполняется семантический поиск, **Then** результаты различаются (не идентичные топ-3)
3. **Given** запрос, **When** результаты возвращаются, **Then** они отсортированы по убыванию similarity score

---

### Edge Cases

- Что происходит, когда база данных недоступна? → Тесты автоматически пропускаются (skip)
- Что происходит, когда нет API-ключа? → Тесты автоматически пропускаются (skip)
- Что происходит, когда LLM не вызывает ни один инструмент? → Тест фиксирует отсутствие tool calls как ошибку
- Что происходит при LLM non-determinism? → Запросы формулируются максимально однозначно; допускается 20% толерантность на числовые фильтры
- Что происходит, если каталог вин пуст? → Тесты используют реальную БД с seed-данными; при отсутствии данных тесты fail

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА включать набор golden queries — эталонных запросов с ожидаемым поведением (инструмент, фильтры, количество результатов)
- **FR-002**: Система ДОЛЖНА проверять, что LLM выбирает корректный инструмент (search_wines или semantic_search) для каждого golden query
- **FR-003**: Система ДОЛЖНА проверять, что LLM извлекает корректные фильтры из естественного языка (тип вина, сладость, цена, сорт, страна)
- **FR-004**: Система ДОЛЖНА обнаруживать галлюцинации — упоминание вин, отсутствующих в каталоге
- **FR-005**: Система ДОЛЖНА проверять качество семантического поиска: релевантность (similarity > 0.15), порядок, дифференциацию
- **FR-006**: Тесты ДОЛЖНЫ автоматически пропускаться, если отсутствует подключение к реальной БД или API-ключ
- **FR-007**: Тесты НЕ ДОЛЖНЫ выполняться в CI по умолчанию — только при наличии инфраструктуры (реальная PostgreSQL + API-ключ)
- **FR-008**: Система ДОЛЖНА использовать spy-паттерн для перехвата вызовов инструментов без изменения бизнес-логики
- **FR-009**: Каждый golden query ДОЛЖЕН иметь уникальный идентификатор, текст запроса на русском, ожидаемый инструмент и ожидаемые фильтры
- **FR-010**: Числовые фильтры (цена) ДОЛЖНЫ проверяться с толерантностью ±20% для учёта LLM non-determinism

### Key Entities

- **Golden Query**: эталонный запрос с ID, текстом на русском, ожидаемым инструментом, ожидаемыми фильтрами, минимальным числом результатов
- **Tool Call Spy**: перехватчик вызовов инструментов, записывающий имя инструмента и аргументы
- **Eval Test Suite**: набор тестов, сгруппированных по 4 категориям: выбор инструмента, точность фильтров, галлюцинации, семантическое качество

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Набор включает >= 14 golden queries, покрывающих все 4 категории проверок
- **SC-002**: >= 75% тестов выбора инструмента (tool selection) проходят стабильно при повторных запусках
- **SC-003**: >= 90% тестов точности фильтров проходят стабильно (числовые фильтры с толерантностью 20%)
- **SC-004**: 100% тестов галлюцинаций проходят (ни одно выдуманное вино не проходит проверку)
- **SC-005**: Тесты семантического поиска демонстрируют дифференциацию — разные запросы возвращают разные топ-3
- **SC-006**: Все тесты автоматически пропускаются без ошибок при отсутствии инфраструктуры
- **SC-007**: Полный прогон eval-тестов завершается менее чем за 5 минут

## Assumptions

- Используется существующая dev-база PostgreSQL с seed-данными (50 вин с embeddings)
- LLM-провайдер: OpenRouter с существующим API-ключом
- Тесты являются интеграционными и не предназначены для CI — запускаются вручную или по расписанию
- LLM non-determinism учтён: запросы формулируются однозначно, допускается толерантность на числовые значения
- Spy-паттерн не влияет на бизнес-логику — только перехватывает и записывает вызовы

## Scope Boundaries

**Включено**:
- Проверка выбора инструмента (search_wines vs semantic_search)
- Проверка извлечения фильтров из естественного языка
- Обнаружение галлюцинаций (вина не из каталога)
- Проверка качества семантического поиска (релевантность, порядок, дифференциация)
- Автоматический skip при недоступной инфраструктуре

**Исключено**:
- Нагрузочное тестирование LLM
- A/B тестирование разных промптов
- Мониторинг качества в production
- Тестирование формата ответа (markdown, секции [INTRO]/[WINE])
- Тестирование пользовательского интерфейса Telegram-бота
