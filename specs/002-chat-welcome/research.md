# Research: Chat Welcome & AI Greeting

**Feature**: 002-chat-welcome
**Date**: 2026-02-02

## 1. Chat Interface Pattern

### Decision: Server-Side Rendering + HTMX

**Rationale**:
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–µ–∫—É –∏–∑ –∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–∏ (HTMX, Jinja2 SSR)
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è MVP
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–±–∏–ª–¥–∞
- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**Alternatives Considered**:
| –í–∞—Ä–∏–∞–Ω—Ç | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã | –†–µ—à–µ–Ω–∏–µ |
|---------|-------|--------|---------|
| SPA (React/Vue) | Rich UX, real-time | –°–ª–æ–∂–Ω–æ—Å—Ç—å, –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–∏–ª–¥ | ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ |
| WebSocket | Real-time updates | –°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã | ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ –¥–ª—è MVP |
| SSR + HTMX | –ü—Ä–æ—Å—Ç–æ—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–µ–∫—É | Polling –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π | ‚úÖ –í—ã–±—Ä–∞–Ω–æ |
| SSR + SSE | Server-sent events | –°–ª–æ–∂–Ω–µ–µ polling | üîÑ –í–æ–∑–º–æ–∂–Ω–æ –≤ v2 |

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```
1. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí GET /chat ‚Üí HTML —Å –∏—Å—Ç–æ—Ä–∏–µ–π
2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí POST /api/v1/chat/messages ‚Üí JSON
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ‚Üí HTMX hx-swap –∏–ª–∏ JS fetch
4. –û—Ç–≤–µ—Ç AI ‚Üí polling –∏–ª–∏ HTMX hx-trigger="every 2s"
```

## 2. Mock AI Service

### Decision: –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π mock —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

**Rationale**:
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å UI –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ LLM
- –ò–º–∏—Ç–∏—Ä—É–µ—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞
- –õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø–æ–∑–∂–µ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```python
class MockAIService:
    async def generate_response(self, message: str, context: list) -> str:
        await asyncio.sleep(0.5)  # –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏
        return self._get_mock_response(message)

    def _get_mock_response(self, message: str) -> str:
        # –ü—Ä–æ—Å—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –¥–µ–º–æ
        if "–ø—Ä–∏–≤–µ—Ç" in message.lower():
            return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à AI-—Å–æ–º–µ–ª—å–µ..."
        return "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è..."
```

**Alternatives Considered**:
- –†–µ–∞–ª—å–Ω—ã–π Claude API ‚Üí –æ—Ç–ª–æ–∂–µ–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –∫–ª—é—á–∏ –∏ –±—é–¥–∂–µ—Ç
- –õ–æ–∫–∞–ª—å–Ω–∞—è LLM ‚Üí —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ –¥–ª—è MVP

## 3. Message Storage

### Decision: –î–≤–µ —Ç–∞–±–ª–∏—Ü—ã ‚Äî Conversation + Message

**Rationale**:
- Conversation –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤ –±—É–¥—É—â–µ–º –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∏–∞–ª–æ–≥–æ–≤
- –ß—ë—Ç–∫–∞—è —Å–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**Schema**:
```
conversations
‚îú‚îÄ‚îÄ id (UUID, PK)
‚îú‚îÄ‚îÄ user_id (FK ‚Üí users.id)
‚îú‚îÄ‚îÄ created_at
‚îî‚îÄ‚îÄ updated_at

messages
‚îú‚îÄ‚îÄ id (UUID, PK)
‚îú‚îÄ‚îÄ conversation_id (FK ‚Üí conversations.id)
‚îú‚îÄ‚îÄ role (enum: user, assistant, system)
‚îú‚îÄ‚îÄ content (text, max 2000 chars)
‚îú‚îÄ‚îÄ created_at
‚îî‚îÄ‚îÄ is_welcome (bool, default false)
```

**Alternatives Considered**:
| –í–∞—Ä–∏–∞–Ω—Ç | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã | –†–µ—à–µ–Ω–∏–µ |
|---------|-------|--------|---------|
| –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ messages | –ü—Ä–æ—Å—Ç–æ—Ç–∞ | –ù–µ—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ | ‚ùå |
| JSON –≤ user profile | –ú–∏–Ω–∏–º—É–º –º–∏–≥—Ä–∞—Ü–∏–π | –ü–ª–æ—Ö–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è | ‚ùå |
| –î–≤–µ —Ç–∞–±–ª–∏—Ü—ã | –ì–∏–±–∫–æ—Å—Ç—å, —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å | –ß—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ | ‚úÖ |

## 4. First Visit Detection

### Decision: –§–ª–∞–≥ has_seen_welcome –≤ User –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

**Rationale**:
- –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç conversation, —ç—Ç–æ –ø–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ system message —Å is_welcome=true

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```python
async def get_or_create_conversation(user_id: UUID) -> Conversation:
    conversation = await repo.get_by_user(user_id)
    if not conversation:
        conversation = await repo.create(user_id)
        await message_repo.create_welcome_message(conversation.id)
    return conversation
```

## 5. UI Components

### Decision: –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —á–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
1. **Header** ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ 18+
2. **Message List** ‚Äî –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π
3. **Input Area** ‚Äî –ø–æ–ª–µ –≤–≤–æ–¥–∞ + –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
4. **Loading Indicator** ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ AI

**–°—Ç–∏–ª–∏–∑–∞—Ü–∏—è**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∏–ª—å –∏–∑ auth —Å—Ç—Ä–∞–Ω–∏—Ü
- –ì—Ä–∞–¥–∏–µ–Ω—Ç —Ñ–æ–Ω–∞, –±–µ–ª—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Å–ø—Ä–∞–≤–∞, AI ‚Äî —Å–ª–µ–≤–∞

## 6. Error Handling

### Decision: Graceful degradation

**–°—Ü–µ–Ω–∞—Ä–∏–∏**:
| –û—à–∏–±–∫–∞ | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|--------|-----------|
| AI timeout (30s) | "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Å–µ–π—á–∞—Å –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." |
| Network error | –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ input |
| Empty message | –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ disabled |
| Too long message | –ü–æ–∫–∞–∑–∞—Ç—å —Å—á—ë—Ç—á–∏–∫, –æ–±—Ä–µ–∑–∞—Ç—å –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ |

## Summary of Decisions

| –û–±–ª–∞—Å—Ç—å | –†–µ—à–µ–Ω–∏–µ |
|---------|---------|
| Frontend | SSR + HTMX |
| AI Service | Mock —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π |
| Storage | Conversation + Message tables |
| First visit | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è conversation |
| Updates | Polling (HTMX) –¥–ª—è MVP |
